#! /usr/bin/env python3

from PoloConfig import PoloConfig
from PoloMallet import PoloMallet
from PoloCorpus import PoloCorpus
import argparse

if __name__ == '__main__':

    # Main parser app
    parser = argparse.ArgumentParser(description='Welcome to Polo')
    parser.add_argument("--ini", help="Path to ini file (default: ./config.ini)", action="store", default='./config.ini')

    # Subparsers for specific activities
    subparsers = parser.add_subparsers(title="Actions", help='Enter choice of corpus or mallet', dest='cmd')

    # SETUP
    parser_corpus = subparsers.add_parser('setup', help='Setups a directory')

    # CORPUS
    parser_corpus = subparsers.add_parser('corpus', help='Generates a corpus db')

    # MALLET
    parser_mallet = subparsers.add_parser('mallet', help='Runs mallet based on ini and saves to db')
    parser_mallet.add_argument('trial', help="Trial name (see ini)", action="store", type=str)
    parser_mallet.add_argument('-t', "--topics", help="Number of topics (override ini)", action="store", type=int)
    parser_mallet.add_argument('-i', "--iters", help="Number of iterations (override ini)", action="store", type=int)

    # Run the app
    args = parser.parse_args()

    if args.cmd == 'corpus':

        print("Import config")
        config = PoloConfig()
        config.read_ini(args.ini)
        trials = config.get_trial_names()

        print("Initialize corpus")
        corpus = PoloCorpus(config)
        corpus.cache_mode = True

        print("Importing stopwords")
        corpus.import_table_stopword(use_nltk=True)

        print("Importing doc")
        corpus.import_table_doc()

        print("Importing doctoken")
        corpus.add_table_doctoken()

        print("Importing token")
        corpus.add_table_token()

        print("Importing bigrams")
        corpus.add_tables_ngram_and_docngram(n=2)

    elif args.cmd == 'mallet':

        print("Import config")
        config = PoloConfig()
        config.read_ini(args.ini)
        trials = config.get_trial_names()

        config.import_ini(trials[0])

        print("Initializing")
        mallet = PoloMallet(config)
        mallet.cache_mode = True

        print('Importing corpus')
        mallet.mallet_import()

        print('Training model')
        mallet.mallet_train()

        print("Putting data into database")
        mallet.tables_to_db()

        print("Adding diagnostics tables")
        mallet.add_diagnostics()

        print("Adding doc table with topic entropy")
        mallet.add_topic_entropy()

        print("Adding topicpair table")
        mallet.create_table_topicpair()

        print("Cleaning up")
        mallet.del_mallet_files()

        print("Done with", mallet.config.trial_name)
