#! /usr/bin/env python3

import argparse, sys, os

from polo2 import PoloConfig
from polo2 import PoloMallet
from polo2 import PoloCorpus
from polo2 import PoloGensim
from polo2 import PoloRetro

if __name__ == '__main__':

    # Main parser app
    parser = argparse.ArgumentParser(description='Welcome to Polo')
    parser.add_argument("--ini", help="Path to ini file (default: ./config.ini)", action="store",
                        default='./config.ini')

    # Subparsers for specific activities
    subparsers = parser.add_subparsers(title="Actions", help='Select an action', dest='cmd')

    # SETUP
    parser_setup = subparsers.add_parser('setup', help='Set up a project directory')
    parser_setup.add_argument('project', help="Short name of project (no spaces, etc.)", action='store')

    # INI
    parser_ini = subparsers.add_parser('ini', help='Create a config file')
    parser_ini.add_argument('-n', '--name', help="Name of config file if not `config.ini`.", action='store')

    # INFO
    parser_info = subparsers.add_parser('info', help='Get project info')
    parser_info.add_argument('item', choices=['trials', 'mallet', 'nltk'])

    # CORPUS
    parser_corpus = subparsers.add_parser('corpus', help='Generates a corpus db')

    # MALLET
    parser_mallet = subparsers.add_parser('mallet', help='Runs mallet based on ini and saves to db')
    parser_mallet.add_argument('trial', help="Trial name (see ini)", action="store", type=str, nargs='?', default=None)
    parser_mallet.add_argument('-t', "--topics", help="Number of topics (override ini)", action="store", type=int)
    parser_mallet.add_argument('-i', "--iters", help="Number of iterations (override ini)", action="store", type=int)

    # RETRO
    parser.retro = subparsers.add_parser('retro', help='Combines the corpus and model dbs for use in older Polo')
    parser.retro.add_argument('-c', '--corpus_dbfile', help="Corpus database name", action="store", type=str, default=None)
    parser.retro.add_argument('-m', '--model_dbfile', help="Mallet model database name", action="store", type=str, default=None)

    # Run the app
    args = parser.parse_args()

    if args.cmd == 'corpus':

        print("Import config")
        try:
            config = PoloConfig(args.ini)
        except ValueError as e:
            print("Can't create config.", e)
            sys.exit(1)

        print("Initialize corpus")
        try:
            corpus = PoloCorpus(config)
        except ValueError as e:
            print("Can't create corpus object.", e)
            sys.exit(1)
        corpus.cache_mode = True

        print("Importing stopwords")
        corpus.import_table_stopword(use_nltk=True)

        print("Importing doc")
        corpus.import_table_doc()

        print("Importing doctoken")
        corpus.add_table_doctoken()
        #corpus.add_table_doctokenbow()

        print("Importing token")
        corpus.add_table_token()

        print("Importing bigrams")
        corpus.add_tables_ngram_and_docngram(n=2)

        print("Export mallet corpus")
        corpus.export_mallet_corpus()

        #print("Running Gensim HDP (experimental)")
        #gs = PoloGensim(config, corpus.dbfile)
        #gs.make_gs_corpus()
        #gs.make_gs_dict()
        #gs.get_hdp()

    elif args.cmd == 'mallet':

        print("Import config")
        try:
            config = PoloConfig(args.ini)
        except ValueError as e:
            print("Can't create config.", e)
            sys.exit(1)
        try:
            trials = config.get_trial_names()
        except ValueError as e:
            print("Can't get trials.", e)
            sys.exit(1)

        this_trial = ''
        if args.trial:
            this_trial = args.trial
        else:
            this_trial = trials[0]

        print("Initializing mallet for {}".format(this_trial))
        try:
            mallet = PoloMallet(config, this_trial)
        except ValueError:
            print("Can't create mallet object. Most likely due to bad trial name.")
            sys.exit(1)

        mallet.cache_mode = True

        print('Importing corpus')
        mallet.mallet_import()

        print('Training model')
        mallet.mallet_train()

        print("Putting data into database")
        mallet.tables_to_db()

        print("Adding diagnostics tables")
        mallet.add_diagnostics()

        print("Adding doc table with topic entropy")
        mallet.add_topic_entropy()

        print("Adding topicpair table")
        mallet.create_table_topicpair()

        print("Cleaning up")
        mallet.del_mallet_files()

        print("Done with", mallet.trial_name)

    elif args.cmd == 'info':

        if args.item == 'trials':
            config = PoloConfig(args.ini)
            trials = config.get_trial_names()
            # GET MORE INFO TO SHOW, e.g. num topics, etc.
            print('TRIALS:\n', '\n'.join(trials))

    elif args.cmd == 'setup':
        slug = args.project
        print("Setting up things for project `{}`".format(slug))

        # CREATE DIRECTORY
        if os.path.isdir(slug):
            r = input("Path already exists. Proceed? [y/n] ")
            if r != 'y':
                print("OK, ciao.")
                sys.exit(1)
        else:
            print("Creating subdir `{}`".format(slug))
            os.mkdir(slug)

        # CREATE CONFIG.INI
        cfg_file = '{}/config.ini'.format(slug)
        if not os.path.isfile(cfg_file):
            print("Creating INI file template `{}`.".format(cfg_file))
            print("When this process is done, edit this file with sensible values.")
            config = PoloConfig(cfg_file, create=True, slug=slug)
        else:
            print("INI file `{}` already exists.".format(cfg_file))

        # CREATE SUBDIRECTORIES
        subdirs = ['corpus', 'trials']
        for subdir in subdirs:
            path = '{}/{}'.format(slug, subdir)
            if not os.path.isdir(path):
                print("Creating subdirectory `{}`.".format(subdir))
                os.mkdir(path)
            else:
                print("Subdirectory `{}` exists.".format(subdir))

    elif args.cmd == 'retro':

        print("Import config")
        try:
            config = PoloConfig(args.ini)
        except ValueError as e:
            print("Can't create config.", e)
            sys.exit(1)

        retro = PoloRetro(config)
        retro.retro_combine(args.corpus_dbfile, args.model_dbfile)
        retro.create_all_tables()

    elif args.cmd == 'ini':
        ini_file = 'config.ini'
        if args.name:
            ini_file = args.name
        if not os.path.isfile(ini_file):
            print("Creating INI file template `{}`. When this process is done, edit this file with sensible values.".format(ini_file))
            config = PoloConfig(ini_file, create=True)
        else:
            print("INI file `{}` already exists.".format(ini_file))

    else:
        parser.print_help()
        sys.exit()
